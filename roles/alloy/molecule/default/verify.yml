---
# Molecule verify playbook for Grafana Alloy role
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
      - name: Check if Alloy package is installed
        ansible.builtin.package_facts:
            manager: auto

      - name: Assert Alloy package is installed
        ansible.builtin.assert:
            that:
                - "'alloy' in ansible_facts.packages"
            fail_msg: "Alloy package is not installed"
            success_msg: "Alloy package is installed"

      - name: Check Alloy service status
        ansible.builtin.systemd_service:
            name: alloy
        register: alloy_service

      - name: Assert Alloy service is running
        ansible.builtin.assert:
            that:
                - alloy_service.status.ActiveState == "active"
                - alloy_service.status.LoadState == "loaded"
            fail_msg: "Alloy service is not running properly"
            success_msg: "Alloy service is running"

      - name: Check if Alloy config file exists
        ansible.builtin.stat:
            path: /etc/alloy/config.alloy
        register: alloy_config

      - name: Assert Alloy config exists
        ansible.builtin.assert:
            that:
                - alloy_config.stat.exists
                - alloy_config.stat.isreg
            fail_msg: "Alloy config file does not exist"
            success_msg: "Alloy config file exists"

      - name: Check if Alloy is listening on port
        ansible.builtin.wait_for:
            port: 12345
            timeout: 10
            state: started
        register: alloy_port_check
        ignore_errors: true

      - name: Verify Alloy modules are configured
        ansible.builtin.stat:
            path: "{{ item }}"
        register: module_files
        loop:
            - /etc/alloy/modules/prometheus.alloy
            - /etc/alloy/modules/node_exporter.alloy
            - /etc/alloy/modules/loki.alloy

      - name: Assert module files exist
        ansible.builtin.assert:
            that:
                - item.stat.exists
            fail_msg: "Module file {{ item.item }} does not exist"
            success_msg: "Module file {{ item.item }} exists"
        loop: "{{ module_files.results }}"
